<script>

    // time slider
    function extractRangeAttributes(class_ = "slider-time",
                                    labels = ["Min", "H", "D", "W", "M"],
                                    n_ticks = 5,
                                    value_map = {
                                        1: "Minute",
                                        2: "Hour",
                                        3: "Day",
                                        4: "Week",
                                        5: "Month"
                                    }
    ) {
        //bind the slider
        $("." + class_).each(function () {
            const this_ = this
            if (!$(this).hasClass("ui-slider")) {
                $(this).slider({
                    range: "min",
                    value: 1,
                    min: 1,
                    max: n_ticks,
                    step: 1,
                    slide: function (event, ui) {
                        // search for closest data-type="time-interval" and update its value
                        var queryFrame = $(this_).closest('.query-frame');
                        {#console.log("THIS", this_)#}
                        {#console.log("EEEE", queryFrame)#}
                        {#console.log(queryFrame)#}
                        var elementsWithDatasetAttribute = queryFrame.find('[data-type="time-interval"]');
                        console.log(class_, ui.value)
                        {#console.log(elementsWithDatasetAttribute)#}
                        queryFrame.find('[data-link=' + class_ + ']').val(labels[ui.value-1]);

                        if (value_map[ui.value] === undefined) {
                            return
                        }
                        elementsWithDatasetAttribute[0].innerText = value_map[ui.value];
                    }
                });
            }


        });

        sliders = document.getElementsByClassName(class_)
        slider = sliders[sliders.length - 1]

        const ticks = slider.nextElementSibling

        if (ticks.hasChildNodes()) {
            return
        }
        //append grid 2 lines 5 columns
        flexContainer = document.createElement("div")
        flexContainer.classList.add("flex-container")
        flexContainer.style.display = "flex"
        flexContainer.style.marginRight = -100 / (n_ticks - 0.9) + "%"

        const flexContainer2 = flexContainer.cloneNode(true)

        flexItem = document.createElement("div")
        flexItem.classList.add("flex-item")
        flexItem.style.flex = "1";
        flexItem.style.border = "None";
        flexItem.style.height = "10px";
        flexItem.style.verticalAlign = "top";
        flexItem.style.overflowY = "hidden";
        flexItem.innerHTML = "<div class='vl'> </div>"

        for (i in labels) {
            var label = labels[i]
            var flexItem2 = flexItem.cloneNode(true)
            flexItem2.innerHTML = "<div>" + label + "</div>"
            flexItem2.style.overflowY = "visible";
            flexContainer2.appendChild(flexItem2)
        }
        for (i = 0; i < n_ticks; i++) {
            flexContainer.appendChild(flexItem.cloneNode(true))
        }
        ticks.appendChild(flexContainer)
        flexContainer2.style.marginLeft = -100 / (labels.length - 1) / 2 + "%"
        flexContainer2.style.marginRight = -100 / (labels.length - 1) / 2 + "%"
        flexContainer2.style.textAlign = "center"
        ticks.appendChild(flexContainer2)
    }

    function get_random_time_stamp() {
        return timeStamp.pop()
    }

    function set_time_stamp(element) {
        var queryFrame = element.closest('.query-frame');
        var timeStamp = get_random_time_stamp();
        var elementsWithDatasetAttribute = queryFrame.querySelectorAll('[data-type="time-stamp"]');
        elementsWithDatasetAttribute.forEach(function (element_) {
            element_.innerText = timeStamp;
        });
        queryFrame.find('[data-link="time-stamp"]').val(timeStamp);
    }

    function swapSelect(divElement) {
        var dataToggle = divElement.children[0].getAttribute("data-toggle");

        var queryFrame = divElement.closest('.query-frame');
        var selectMain = queryFrame.querySelector('.select-main');

        var selectMainInnerHTML = selectMain.innerHTML;
        selectMain.innerHTML = divElement.innerHTML;
        // divElement.innerHTML = selectMainInnerHTML ;

        var contentDiv = queryFrame.querySelector('.query-content');
        // set the direct children to be visible if id = select-dataToggle
        var children = contentDiv.children;
        for (var i = 0; i < children.length; i++) {
            var child = children[i];
            if (child.parentElement !== contentDiv) {
                continue;
            }
            if (child.classList.contains("select-" + dataToggle)) {
                child.style.display = "block";
            } else {
                child.style.display = "none";
            }
        }
    }

    function initQueryFrame() {
        const swapSelections = document.querySelectorAll('.swap-select');
        // Add a click event handler to each element
        swapSelections.forEach(function (element) {
            element.addEventListener('click', function () {
                swapSelect(element);
            });
        })

        // get all elements of class dataset-select
        const datasetSelect = document.querySelectorAll('.dataset-select');
        // Add a click event handler to each element
        datasetSelect.forEach(function (element) {
            element.addEventListener('click', function () {
                var queryFrame = element.closest('.query-frame');
                var elementsWithDatasetAttribute = queryFrame.querySelectorAll('[data-type="dataset"]');
                elementsWithDatasetAttribute.forEach(function (element_) {
                    element_.innerText = element.value;
                });
            });
        });

        // get all elements of class time-range-select
        const timeRangeSelect = document.querySelectorAll('.time-range-select');
        // Add a click event handler to each element
        timeRangeSelect.forEach(function (element) {
            console.log("element", element);
            console.log("value", element.value);
            element.addEventListener('click', function () {
                var queryFrame = element.closest('.query-frame');
                console.log("query frame", queryFrame)
                var elementsWithDatasetAttribute = queryFrame.querySelectorAll('[data-type="time-interval"]');
                elementsWithDatasetAttribute.forEach(function (element_) {
                    element_.innerText = element.value;
                });
            });
        });

        //handle sub-select
        const swapSubSelections = document.querySelectorAll('.swap-sup-select');
        // Add a click event handler to each element
        swapSubSelections.forEach(function (element) {
            element.addEventListener('click', function () {
                var queryFrame = element.closest('.dropdown');
                var selectMain = queryFrame.querySelector('.sub-select-main');
                var selectMainInnerHTML = selectMain.innerHTML;
                selectMain.innerHTML = element.innerHTML;
                //element.innerHTML = selectMainInnerHTML;

            });
        })

        //handle query submit
        const querySubmit = document.querySelectorAll('.query-submit');
        // Add a click event handler to each element
        querySubmit.forEach(function (element) {
            element.addEventListener('click', function (event) {
                event.preventDefault()
                var queryFrame = element.closest('.query-frame');
                //update time stamp
                set_time_stamp(element);
            })
        })


        $('.form-info').popover({
            placement: 'top', // Set the popover placement
            trigger: 'hover', // Trigger the popover when the element is focused
            content: function () {
                return $(this).data('content'); // Get the content from the data attribute
            },
        });

        extractRangeAttributes()
        extractRangeAttributes("slider-sensors", [1, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100], 11, {})
        extractRangeAttributes("slider-stations", [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], 10, {})

    }


    $(document).ready(function () {
        var queryFrameHolder = document.getElementById("query-frame-holder");
        var newDiv = document.createElement("div");
        newDiv.innerHTML = queryFrameContent;
        queryFrameHolder.appendChild(newDiv);
        initQueryFrame();

        // add on click to add query button
        var addQueryButton = document.getElementById("add-query-button");
        addQueryButton.addEventListener("click", function () {
            initQueryFrame();
            var newDiv = document.createElement("div");
            newDiv.innerHTML = queryFrameContent;
            queryFrameHolder.appendChild(newDiv);
            initQueryFrame();
        });
    });

</script>